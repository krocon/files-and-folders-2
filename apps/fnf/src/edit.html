<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>FnF Edit</title>
  <link
      href="assets/favicon-folder-open-o.ico"
      rel="shortcut icon"
      type="image/x-icon">

  <style>
    :root {
      --toast-background: rgba(76, 175, 80, 0.6);
      --toast-text-color: #ffffff;
      --toast-animation-time: 0.5s;
      --toast-display-time: 5s;
    }

    html, body {
      margin: 0;
      padding: 0;
      border: 0;
      width: 100vw;
      height: 100vh;
      overflow: clip;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    body {
      --vscode-button-background: #0e639c;
      --vscode-button-foreground: #ffffff;
      --vscode-button-separator: rgba(255, 255, 255, 0.4);
      --vscode-button-hoverBackground: #1177bb;
      --vscode-focusBorder: #007fd4;
      --vscode-button-secondaryBackground: #0e639c;
      --vscode-button-secondaryForeground: #ffffff;
      --vscode-button-secondaryHoverBackground: #1177bb;

      --vscode-breadcrumb-background: #1e1e1e;
      --vscode-breadcrumb-foreground: rgba(204, 204, 204, 0.8);

      background-color: var(--vscode-breadcrumb-background);
      color: var(--vscode-breadcrumb-foreground);

      display: grid;
      grid-template-rows: auto 1fr auto;
      width: 100vw;
      height: 100vh;
    }

    .toast-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      z-index: 9999;
      pointer-events: none;
    }

    .toast {
      background-color: var(--toast-background);
      color: var(--toast-text-color);
      padding: 12px 24px;
      border-radius: 4px;
      margin-top: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 250px;
      max-width: 80%;
      opacity: 0;
      transform: translateY(-100%);
      transition: transform var(--toast-animation-time), opacity var(--toast-animation-time);
      pointer-events: auto;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-message {
      flex-grow: 1;
      margin-right: 12px;
    }

    .toast-close {
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      line-height: 1;
    }

    .title-div {
      padding: 8px 16px;
    }

    .base {
      font-weight: bold;
      font-size: 1.2em;
      background-color: var(--vscode-breadcrumb-background, #1e1e1e);
      color: var(--vscode-breadcrumb-foreground, rgba(204, 204, 204, 0.8));
    }

    .dir {
      font-weight: normal;
      font-size: 0.8em;
    }

    .button-div {
      padding: 8px 16px;
      display: grid;
      grid-template-columns: auto 1fr auto;
    }

    button {
      padding: 8px 18px;
      border-radius: 4px;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground) !important;
      border-color: var(--vscode-button-separator);
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    button:focus {
      border-color: var(--vscode-focusBorder);
    }

    button.secondary {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    button.secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--vscode-breadcrumb-background, #1e1e1e);
      border: 1px solid var(--vscode-focusBorder, #007fd4);
      border-radius: 6px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(204, 204, 204, 0.2);
    }

    .modal-header h3 {
      margin: 0;
      color: var(--vscode-breadcrumb-foreground, rgba(204, 204, 204, 0.8));
      font-size: 1.2em;
    }

    .modal-body {
      padding: 20px;
      color: var(--vscode-breadcrumb-foreground, rgba(204, 204, 204, 0.8));
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(204, 204, 204, 0.2);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
  <script src="/assets/monaco/min/vs/loader.js"></script>
</head>
<body>

<div
    class="toast-container"
    id="toastContainer">
  <div
      class="toast"
      id="toast">
    <div
        class="toast-message"
        id="toastMessage"></div>
    <div
        class="toast-close"
        id="toastClose">&times;
    </div>
  </div>
</div>

<div
    class="modal-overlay"
    id="confirmModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Unsaved Changes</h3>
    </div>
    <div class="modal-body">
      <p>You have unsaved changes. Do you want to close without saving?</p>
    </div>
    <div class="modal-footer">
      <button
          id="cancelCloseBtn"
          class="secondary">Cancel
      </button>
      <button id="confirmCloseBtn">Close without saving</button>
    </div>
  </div>
</div>

<div class="title-div">
  <div class="base">&nbsp;</div>
  <div class="dir">&nbsp;</div>
</div>

<div id="container"></div>

<div class="button-div">
  <button
      class="secondary"
      id="closeBtn">Close
  </button>
  <div></div>
  <button id="saveBtn">Save</button>
</div>

<script>
  // Configuration
  const API_PORT = 3333;
  let editor = null;
  let fileItem = null;
  let filePath = null;
  let contentModified = false;

  // Language mapping for Monaco editor
  function getMonacoLanguageFromFileSuffix(fileSuffix) {
    const normalizedSuffix = fileSuffix.startsWith(".")
        ? fileSuffix.toLowerCase()
        : `.${fileSuffix.toLowerCase()}`;

    const extensionToLanguageMap = {
      ".html": "html",
      ".htm": "html",
      ".css": "css",
      ".scss": "scss",
      ".less": "less",
      ".js": "javascript",
      ".jsx": "javascript",
      ".ts": "typescript",
      ".tsx": "typescript",
      ".json": "json",
      ".jsonc": "json",
      ".xml": "xml",
      ".svg": "xml",
      ".md": "markdown",
      ".markdown": "markdown",
      ".txt": "plaintext",
      ".java": "java",
      ".py": "python",
      ".rb": "ruby",
      ".php": "php",
      ".cs": "csharp",
      ".cpp": "cpp",
      ".c": "c",
      ".h": "cpp",
      ".hpp": "cpp",
      ".go": "go",
      ".rs": "rust",
      ".swift": "swift",
      ".kt": "kotlin",
      ".yaml": "yaml",
      ".yml": "yaml",
      ".toml": "toml",
      ".ini": "ini",
      ".config": "xml",
      ".properties": "properties",
      ".sh": "shell",
      ".bash": "shell",
      ".zsh": "shell",
      ".ps1": "powershell",
      ".bat": "bat",
      ".cmd": "bat",
      ".sql": "sql",
      ".docker": "dockerfile",
      ".dockerfile": "dockerfile",
      ".graphql": "graphql",
      ".gql": "graphql",
    };

    return extensionToLanguageMap[normalizedSuffix] || "plaintext";
  }

  // Path utilities
  function fixPath(dir) {
    return dir.replace(/\/{2,}/g, "/");
  }

  // CSS utilities
  function getVSCodeProperties(element) {
    const computedStyle = getComputedStyle(element);
    return Array.from(computedStyle)
        .filter(prop => {
          const value = computedStyle.getPropertyValue(prop);
          return prop.startsWith("--vscode")
              && (value.startsWith("rgb") || value.startsWith("#"));
        })
        .map(prop => [prop, computedStyle.getPropertyValue(prop)]);
  }

  function applyVSCodeTheme(editorElement) {
    const properties = getVSCodeProperties(editorElement);
    properties.forEach(([prop, value]) => {
      document.body.style.setProperty(prop, value);
    });
  }

  // File operations
  function loadFileData() {
    const storedData = localStorage.getItem("edit-selected-data");
    if (!storedData) {
      return false;
    }

    fileItem = JSON.parse(storedData);
    updateFileInfo(fileItem);
    filePath = fixPath(fileItem.dir + "/" + fileItem.base);
    return true;
  }

  function updateFileInfo(fileData) {
    document.querySelector(".base").innerText = fileData.base;
    document.querySelector(".dir").innerText = fileData.dir;
  }

  function fetchFileContent() {
    const url = `${location.protocol}//${location.hostname}:${API_PORT}/api/file?name=${filePath}`;

    return fetch(url, {
      headers: {
        "Accept": "application/text"
      }
    })
        .then(response => response.text());
  }

  function saveFileContent() {
    if (!editor || !filePath) return;

    const content = editor.getValue();
    const url = `${location.protocol}//${location.hostname}:${API_PORT}/api/file?name=${filePath}`;

    return fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/text"
      },
      body: content
    })
        .then(response => {
          if (response.error) {
            alert("Error saving file: " + response.error);
          } else {
            contentModified = false;
            showToast("File saved successfully");
          }
        })
        .catch(error => {
          console.error("Error saving file:", error);
          alert("Error saving file");
        });
  }

  // Editor initialization
  function createEditor(content) {
    const editorOptions = {
      value: content,
      language: getMonacoLanguageFromFileSuffix(fileItem.ext),
      theme: "vs-dark",
      automaticLayout: true
    };

    const editorElement = document.getElementById("container");
    editor = monaco.editor.create(editorElement, editorOptions);

    // Add change listener to detect modifications
    editor.onDidChangeModelContent(() => {
      contentModified = true;
    });

    return editor;
  }

  function initMonacoEditor() {
    require.config({paths: {vs: location.origin + "/assets/monaco/min/vs"}});
    require(["vs/editor/editor.main"], function () {
      monaco.editor.onDidCreateEditor(editor => {
        setTimeout(() => {
          const monacoElement = document.querySelector(".monaco-editor");
          if (monacoElement) {
            applyVSCodeTheme(monacoElement);
          }
        }, 100);
      });

      if (loadFileData()) {
        fetchFileContent()
            .then(content => {
              createEditor(content);
            })
            .catch(error => {
              console.error("Error loading file:", error);
              alert("Error loading file content");
            });
      }
    });
  }

  // Toast notification functions
  function showToast(message) {
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");

    // Set the message
    toastMessage.textContent = message;

    // Show the toast
    toast.classList.add("show");

    // Hide the toast after the display time
    const displayTime = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--toast-display-time")) * 1000 || 5000;

    // Clear any existing timeout
    if (toast.timeoutId) {
      clearTimeout(toast.timeoutId);
    }

    // Set new timeout
    toast.timeoutId = setTimeout(() => {
      hideToast();
    }, displayTime);
  }

  function hideToast() {
    const toast = document.getElementById("toast");
    toast.classList.remove("show");
  }

  // Modal dialog functions
  function showConfirmModal(onConfirm, onCancel) {
    const modal = document.getElementById("confirmModal");
    const confirmBtn = document.getElementById("confirmCloseBtn");
    const cancelBtn = document.getElementById("cancelCloseBtn");

    // Show the modal
    modal.classList.add("show");

    // Set up event listeners for the buttons
    const confirmHandler = () => {
      hideConfirmModal();
      if (onConfirm) onConfirm();

      // Remove event listeners
      confirmBtn.removeEventListener("click", confirmHandler);
      cancelBtn.removeEventListener("click", cancelHandler);
    };

    const cancelHandler = () => {
      hideConfirmModal();
      if (onCancel) onCancel();

      // Remove event listeners
      confirmBtn.removeEventListener("click", confirmHandler);
      cancelBtn.removeEventListener("click", cancelHandler);
    };

    // Add event listeners
    confirmBtn.addEventListener("click", confirmHandler);
    cancelBtn.addEventListener("click", cancelHandler);

    // Add escape key handler
    const escHandler = (event) => {
      if (event.key === "Escape") {
        cancelHandler();
        document.removeEventListener("keydown", escHandler);
      }
    };

    document.addEventListener("keydown", escHandler);
  }

  function hideConfirmModal() {
    const modal = document.getElementById("confirmModal");
    modal.classList.remove("show");
  }

  // Event handlers
  function setupEventListeners() {
    const closeButton = document.getElementById("closeBtn");
    const saveButton = document.getElementById("saveBtn");
    const toastClose = document.getElementById("toastClose");

    closeButton.addEventListener("click", () => {
      if (contentModified) {
        showConfirmModal(
            // onConfirm callback - user clicked "Close without saving"
            () => {
              window.close();
            },
            // onCancel callback - user clicked "Cancel" or pressed Escape
            () => {
              // Do nothing, just keep the editor open
            }
        );
      } else {
        window.close();
      }
    });

    saveButton.addEventListener("click", () => {
      saveFileContent();
    });

    toastClose.addEventListener("click", () => {
      hideToast();
    });
  }

  // Initialize application
  function init() {
    setupEventListeners();
    initMonacoEditor();
  }

  // Start the application
  init();
</script>
</body>
</html>
